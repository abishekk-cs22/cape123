<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
>
<head>
    <meta charset="UTF-8">
    <title>Student Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <script>
    $(document).ready(
			function() {

				var formData = null;
				var student_id_for_delete = null;
				var student_id = null;
				// SUBMIT FORM

				$("#saveBtn").click(function(event) {
					// Prevent the form from submitting via the browser.

					student_id = $("#student_id").val();
			    	var student_name = $("#student_name").val();
			    	var address = $("#address").val();
			    	var phone = $("#phone").val();
			    	var email = $("#email").val();
			    	var gender_id = $("#gender").val();
					
//					if(student_name && description && student_name.length>0 && description.length>0 && due_date && is_completed && due_date.length>0 && is_completed.length>0) {
						event.preventDefault();
						formData = {
								name: student_name,
								address: address,
								phone: phone,
								email: email,
								gender: {
									id: gender_id						
								}
						}

						$(this).prop("disabled", true);
						$("#outputMessage").text('');
						ajaxSave();
//					} else {
//						$("#outputMessage").text('Please enter all the details');
//					}
				});

				function ajaxSave() {
					
					// DO POST
					$.ajax({
								type : student_id ? "PUT" : "POST",
								contentType : "application/json",
								url : student_id ? "/api/student/"+student_id : "/api/student",
								data : JSON.stringify(formData),
								dataType : "text",
								success : function(result) {
									//alert('result: '+JSON.stringify(result));
									//alert('result: '+result);
									//$("#outputMessage").replaceWith(result);
									//$("#outputMessage").text(result);									
									//$("#saveBtn").prop("disabled", false);
									//alert('result in Text format: '+ result);
									//alert('result in Number format: '+ parseInt(result));
									//if(parseInt(result)>0){
//										location.replace('/students');
	//								}

									if(student_id>0){
										//alert('Data updated Successfully.');
										$("#outputMessage").replaceWith('Data updated Successfully.');
									} else {
										//alert('Data Added Successfully.');
										$("#outputMessage").replaceWith('Data Added Successfully.');
									}
									$("#saveBtn").prop("disabled", false);
								},
								error : function(error) {
									$("#outputMessage").text(error.responseText);
									$("#saveBtn").prop("disabled", false);
									//alert('Error Occurred.'+error.responseText);
								}
							});
				}

				$("#deleteBtn").click(function(event) {
						student_id_for_delete = $("#student_id").val();
						$(this).prop("disabled", true);
						ajaxDelete();
				});				

				function ajaxDelete() {
					
					// DO DELETE
					$
							.ajax({
								type : "DELETE",
								contentType : "application/json",
								url : "/api/student/"+student_id_for_delete,
								dataType : 'text',
								success : function(result) {
									if(result=='Data deleted successfully'){ //Refactor
										location.replace('/students');
									}
								},
								error : function(error) {
									$("#outputMessage").text(error.responseText);
									$("#saveBtn").prop("disabled", false);
								}
							});
				}
			})    
    </script>
</head>
<body>
<th:block th:include="/students_menu"></th:block>
<br />
<br />
<br />
<div class="container">
    <div class="row col-md-8 offset-md-2">
        <div class="card">
            <div th:if="${param.success}">
                <div class="alert alert-info">You've successfully registered
                    to our app!</div>
            </div>		            
            <div class="card-header">
                <h2 class="text-center" th:utext="${student} ? ${title}: 'New student'"></h2>
            </div>
            <div class="card-body">
                <form name="prepareDownload" method="post" role="form">
                    <div class="form-group mb-3">
                    	<span id="outputMessage"></span>
                    </div>
                    <div class="form-group mb-3">
                        <!-- label class="form-label">student Id</label -->               
		                    <input class="form-control"
		                           id="student_id"
		                           name="student_id"
		                           placeholder=""
		                           th:value="${student} ? ${student.id} :-1"
		                           type="text"
		                           hidden=true
		                           autocomplete="off"
		                    />
                    </div>                    
                    <div class="form-group mb-3">
                        <label class="form-label">Student Name</label>
                        <input class="form-control"
                               id="student_name"
                               name="student_name"
                               placeholder=""
                               th:value="${student} ? ${student.name}:''"
                               type="text"
                               autocomplete="off"
                        />        
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Address</label>
                        <input class="form-control"
                               id="address"
                               name="address"
                               placeholder=""
                               th:value="${student} ? ${student.address}:''"
                               type="text"
                               autocomplete="off"
                        />
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Phone</label>
                        <input class="form-control"
                               id="phone"
                               name="phone"
                               placeholder=""
                               th:value="${student} ? ${student.phone}:''"
                               type="text"
                               autocomplete="off"
                        />
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label">Email</label>
                        <input class="form-control"
                               id="email"
                               name="email"
                               placeholder=""
                               th:value="${student} ? ${student.email}:''"
                               type="text"
                               autocomplete="off"
                        />
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label">Gender</label>
                        <select class="form-control" id="gender" name="gender" th:field="*{student.gender}">
						    <option  th:each ="gender : ${genders}" th:value=${gender.id} th:text=${gender.name}></option>
						</select>                        
                    </div>
                    <div class="form-group mb-3">
                        <button id="saveBtn" name="saveBtn" class="btn btn-primary" type="button" th:utext="${student.id} ? 'Update' : 'Add'"> </button>
                        <button th:if="${student.id}" id="deleteBtn" name="deleteBtn" class="btn btn-danger" type="button">Delete</button>
                        <!--span>Already registered? <a href="/" th:href="@{/login}">Login
                             here</a></span-->
                    </div>
                    
                </form>
            </div>
        </div>
    </div>
</div>
</body>
</html>